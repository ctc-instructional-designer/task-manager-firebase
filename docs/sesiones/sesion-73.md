## üîê Sesi√≥n 73: Introducci√≥n a Firebase Authentication

### üéØ Objetivos de la sesi√≥n
- Configurar Firebase Authentication en el proyecto
- Comprender conceptos b√°sicos de autenticaci√≥n
- Instalar y configurar las dependencias necesarias
- Preparar estructura base para manejo de usuarios
- Establecer flujo de autenticaci√≥n general

### üìã Contenidos clave
‚úÖ **Firebase Auth setup** - Configuraci√≥n inicial de autenticaci√≥n
‚úÖ **Estructura de usuarios** - Como funcionan las sesiones
‚úÖ **Preparaci√≥n del c√≥digo** - Servicios y contextos base

---

### üèóÔ∏è Implementaci√≥n paso a paso

#### Paso 1: Conceptos fundamentales de autenticaci√≥n
> **Concepto:** Entender qu√© es y por qu√© necesitamos autenticaci√≥n

```javascript
// üéØ ¬øQU√â ES LA AUTENTICACI√ìN?
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  üåê Cliente (React)         üî• Firebase Auth        üíæ Firestore ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê        ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îÇ
‚îÇ  ‚îÇ üßë‚Äçüíª Usuario      ‚îÇ ‚îÄ‚îÄ‚îÄ‚îÄ‚Üí  ‚îÇ üîê Verificar    ‚îÇ ‚îÄ‚îÄ‚Üí ‚îÇ üìÑ Datos  ‚îÇ ‚îÇ
‚îÇ  ‚îÇ email/password  ‚îÇ        ‚îÇ - Credenciales  ‚îÇ    ‚îÇ del user  ‚îÇ ‚îÇ
‚îÇ  ‚îÇ Google OAuth    ‚îÇ        ‚îÇ - Generar token ‚îÇ    ‚îÇ           ‚îÇ ‚îÇ
‚îÇ  ‚îÇ Facebook, etc   ‚îÇ        ‚îÇ - Mantener      ‚îÇ    ‚îÇ           ‚îÇ ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò        ‚îÇ   sesi√≥n        ‚îÇ    ‚îÇ           ‚îÇ ‚îÇ
‚îÇ                             ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îÇ
‚îÇ                                     ‚îÇ                            ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê                ‚ñº                            ‚îÇ
‚îÇ  ‚îÇ üè† App protegida‚îÇ ‚óÑ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ üé´ ID Token                        ‚îÇ
‚îÇ  ‚îÇ - Ver tareas    ‚îÇ        (Proof de identidad)                ‚îÇ ‚îÇ
‚îÇ  ‚îÇ - Crear tareas  ‚îÇ                                            ‚îÇ
‚îÇ  ‚îÇ - Solo del user ‚îÇ                                            ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò                                            ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

// ‚ú® BENEFICIOS DE FIREBASE AUTH
‚îú‚îÄ‚îÄ üîí Seguridad manejada por Google
‚îú‚îÄ‚îÄ üöÄ M√∫ltiples m√©todos de login (email, Google, Facebook, etc)
‚îú‚îÄ‚îÄ üé´ Tokens JWT autom√°ticos
‚îú‚îÄ‚îÄ üîÑ Manejo de sesiones autom√°tico
‚îú‚îÄ‚îÄ üì± Funciona en web, m√≥vil, etc
‚îî‚îÄ‚îÄ üõ°Ô∏è Integraci√≥n perfecta con Firestore Rules
```

**Flujo completo que implementaremos:**
- üö™ **Login/Register** - Usuario entra credenciales
- üîê **Verificaci√≥n** - Firebase valida y genera token
- üé´ **Sesi√≥n activa** - Token se usa autom√°ticamente
- üìÑ **Datos protegidos** - Solo ve/edita sus propias tareas
- üö™ **Logout** - Limpiar sesi√≥n y redirigir

#### Paso 2: Configurar Firebase Authentication
> **Archivo:** Firebase Console
> **Acci√≥n:** Habilitar m√©todos de autenticaci√≥n

```bash
# üî• CONFIGURAR EN FIREBASE CONSOLE

# 1Ô∏è‚É£ Ir a Firebase Console > Authentication
# 2Ô∏è‚É£ Click en "Comenzar"
# 3Ô∏è‚É£ Ir a "Sign-in method"
# 4Ô∏è‚É£ Habilitar proveedores:

# ‚úÖ HABILITAR: Email/Password
# - Provider: Email/Password
# - Enable: ‚úì Activado
# - Email link (passwordless sign-in): ‚ùå (por ahora)

# ‚úÖ HABILITAR: Google Sign-In
# - Provider: Google
# - Enable: ‚úì Activado
# - Project support email: tu-email@gmail.com
# - Project public-facing name: "Task Manager"

# üöÄ CONFIGURAR DOMINIOS AUTORIZADOS
# - localhost (ya incluido)
# - tu-dominio-de-produccion.com (agregar m√°s tarde)
```

#### Paso 3: Instalar dependencias de autenticaci√≥n
> **Archivo:** Terminal
> **Acci√≥n:** Instalar Firebase Auth

```bash
# üöÄ Las dependencias ya est√°n instaladas desde sesiones anteriores
# Verificar que package.json tiene:
npm list firebase
# Debe mostrar: firebase@^9.x.x (o superior)

# Si no est√° instalado:
# npm install firebase

# üì¶ Firebase Auth ya viene incluido en el paquete firebase
# No necesitamos instalaci√≥n adicional
```

#### Paso 4: Configurar Firebase Auth en el proyecto
> **Archivo:** `src/services/firebase.js`
> **Acci√≥n:** Agregar configuraci√≥n de Auth

```javascript
// üî• Importar Firebase y servicios
import { initializeApp } from 'firebase/app';
import { getFirestore } from 'firebase/firestore';
import { getAuth } from 'firebase/auth'; // üëà NUEVO: Importar Auth

// ‚öôÔ∏è Configuraci√≥n de Firebase (ya existente)
const firebaseConfig = {
  apiKey: "tu-api-key",
  authDomain: "tu-proyecto.firebaseapp.com",
  projectId: "tu-proyecto-id",
  storageBucket: "tu-proyecto.appspot.com",
  messagingSenderId: "123456789",
  appId: "1:123456789:web:abcdef123456"
};

// üöÄ Inicializar Firebase
const app = initializeApp(firebaseConfig);

// üíæ Inicializar Firestore (ya existente)
export const db = getFirestore(app);

// üîê Inicializar Authentication (NUEVO)
export const auth = getAuth(app);

// üéØ Configuraciones adicionales de Auth
auth.useDeviceLanguage(); // Usar idioma del dispositivo para emails

console.log('üî• Firebase inicializado:', {
  projectId: firebaseConfig.projectId,
  authDomain: firebaseConfig.authDomain,
  firestoreConnected: !!db,
  authConnected: !!auth  // üëà NUEVO: Verificar Auth
});

// üöÄ Exportar configuraci√≥n para uso en otros archivos
export default app;
```

#### Paso 5: Crear servicio de autenticaci√≥n
> **Archivo:** `src/services/authService.js`
> **Acci√≥n:** Funciones b√°sicas de autenticaci√≥n

```javascript
import {
  createUserWithEmailAndPassword,
  signInWithEmailAndPassword,
  signOut,
  GoogleAuthProvider,
  signInWithPopup,
  onAuthStateChanged,
  updateProfile
} from 'firebase/auth';
import { auth } from './firebase';

// üéØ REGISTRO CON EMAIL Y PASSWORD
export const registerWithEmail = async (email, password, displayName) => {
  try {
    console.log('üìù Registrando usuario:', email);

    // ‚úÖ Crear usuario en Firebase Auth
    const result = await createUserWithEmailAndPassword(auth, email, password);
    const user = result.user;

    // ‚úÖ Actualizar nombre del usuario
    if (displayName) {
      await updateProfile(user, {
        displayName: displayName
      });
    }

    console.log('‚úÖ Usuario registrado exitosamente:', user.uid);
    return {
      success: true,
      user: {
        uid: user.uid,
        email: user.email,
        displayName: displayName || user.email,
        emailVerified: user.emailVerified
      }
    };

  } catch (error) {
    console.error('‚ùå Error en registro:', error);
    return {
      success: false,
      error: getAuthErrorMessage(error.code)
    };
  }
};

// üîê LOGIN CON EMAIL Y PASSWORD
export const loginWithEmail = async (email, password) => {
  try {
    console.log('üîê Iniciando sesi√≥n:', email);

    // ‚úÖ Autenticar en Firebase
    const result = await signInWithEmailAndPassword(auth, email, password);
    const user = result.user;

    console.log('‚úÖ Sesi√≥n iniciada exitosamente:', user.uid);
    return {
      success: true,
      user: {
        uid: user.uid,
        email: user.email,
        displayName: user.displayName || user.email,
        emailVerified: user.emailVerified
      }
    };

  } catch (error) {
    console.error('‚ùå Error en login:', error);
    return {
      success: false,
      error: getAuthErrorMessage(error.code)
    };
  }
};

// üîê LOGIN CON GOOGLE
export const loginWithGoogle = async () => {
  try {
    console.log('üîê Iniciando sesi√≥n con Google...');

    // ‚úÖ Configurar proveedor de Google
    const provider = new GoogleAuthProvider();
    provider.addScope('email');
    provider.addScope('profile');

    // ‚úÖ Mostrar popup de Google
    const result = await signInWithPopup(auth, provider);
    const user = result.user;

    console.log('‚úÖ Sesi√≥n con Google exitosa:', user.uid);
    return {
      success: true,
      user: {
        uid: user.uid,
        email: user.email,
        displayName: user.displayName,
        photoURL: user.photoURL,
        emailVerified: user.emailVerified
      }
    };

  } catch (error) {
    console.error('‚ùå Error en login con Google:', error);

    // üö´ Manejar cancelaci√≥n del usuario
    if (error.code === 'auth/popup-closed-by-user') {
      return {
        success: false,
        error: 'Inicio de sesi√≥n cancelado por el usuario'
      };
    }

    return {
      success: false,
      error: getAuthErrorMessage(error.code)
    };
  }
};

// üö™ CERRAR SESI√ìN
export const logout = async () => {
  try {
    console.log('üö™ Cerrando sesi√≥n...');

    await signOut(auth);

    console.log('‚úÖ Sesi√≥n cerrada exitosamente');
    return {
      success: true
    };

  } catch (error) {
    console.error('‚ùå Error al cerrar sesi√≥n:', error);
    return {
      success: false,
      error: 'Error al cerrar sesi√≥n'
    };
  }
};

// üëÄ OBSERVAR CAMBIOS DE ESTADO DE AUTENTICACI√ìN
export const onAuthStateChange = (callback) => {
  return onAuthStateChanged(auth, (user) => {
    if (user) {
      // ‚úÖ Usuario est√° logueado
      callback({
        isLoggedIn: true,
        user: {
          uid: user.uid,
          email: user.email,
          displayName: user.displayName || user.email,
          photoURL: user.photoURL,
          emailVerified: user.emailVerified
        }
      });
    } else {
      // ‚ùå Usuario no est√° logueado
      callback({
        isLoggedIn: false,
        user: null
      });
    }
  });
};

// üéØ OBTENER USUARIO ACTUAL
export const getCurrentUser = () => {
  const user = auth.currentUser;

  if (user) {
    return {
      uid: user.uid,
      email: user.email,
      displayName: user.displayName || user.email,
      photoURL: user.photoURL,
      emailVerified: user.emailVerified
    };
  }

  return null;
};

// üéØ MAPEAR ERRORES DE FIREBASE A MENSAJES USER-FRIENDLY
const getAuthErrorMessage = (errorCode) => {
  const errorMessages = {
    'auth/user-disabled': 'Esta cuenta ha sido deshabilitada',
    'auth/user-not-found': 'No existe una cuenta con este email',
    'auth/wrong-password': 'Contrase√±a incorrecta',
    'auth/email-already-in-use': 'Ya existe una cuenta con este email',
    'auth/weak-password': 'La contrase√±a debe tener al menos 6 caracteres',
    'auth/invalid-email': 'El formato del email no es v√°lido',
    'auth/invalid-credential': 'Las credenciales no son v√°lidas',
    'auth/too-many-requests': 'Demasiados intentos fallidos. Intenta m√°s tarde',
    'auth/popup-blocked': 'El popup fue bloqueado por el navegador',
    'auth/popup-closed-by-user': 'Inicio de sesi√≥n cancelado',
    'auth/cancelled-popup-request': 'Solo se permite un popup a la vez',
    'auth/network-request-failed': 'Error de conexi√≥n de red'
  };

  return errorMessages[errorCode] || 'Ha ocurrido un error inesperado';
};

// üéØ UTILIDADES ADICIONALES
export const isLoggedIn = () => {
  return !!auth.currentUser;
};

export const getUserEmail = () => {
  return auth.currentUser?.email || null;
};

export const getUserId = () => {
  return auth.currentUser?.uid || null;
};
```

#### Paso 6: Crear contexto de autenticaci√≥n
> **Archivo:** `src/contexts/AuthContext.jsx`
> **Acci√≥n:** Proveedor global de estado de autenticaci√≥n

```jsx
import { createContext, useContext, useEffect, useState } from 'react';
import { onAuthStateChange } from '../services/authService';

// üéØ Crear contexto de autenticaci√≥n
const AuthContext = createContext();

// üéØ Hook personalizado para usar el contexto
export const useAuth = () => {
  const context = useContext(AuthContext);
  if (context === undefined) {
    throw new Error('useAuth debe ser usado dentro de un AuthProvider');
  }
  return context;
};

// üéØ Proveedor de contexto de autenticaci√≥n
export const AuthProvider = ({ children }) => {

  // üìä Estados globales de autenticaci√≥n
  const [authState, setAuthState] = useState({
    isLoggedIn: false,
    user: null,
    loading: true // Importante: iniciar en loading=true
  });

  // üëÄ Escuchar cambios de estado de autenticaci√≥n
  useEffect(() => {
    console.log('üîê Configurando listener de autenticaci√≥n...');

    const unsubscribe = onAuthStateChange((authData) => {
      console.log('üîÑ Estado de auth cambiado:', authData);

      setAuthState({
        ...authData,
        loading: false // Ya termin√≥ de cargar
      });
    });

    // üßπ Cleanup: Desuscribirse cuando el componente se desmonte
    return () => {
      console.log('üßπ Desuscribiendo listener de auth');
      unsubscribe();
    };
  }, []);

  // üéØ M√©todos auxiliares para el contexto
  const contextValue = {
    // üìä Estado actual
    ...authState,

    // üéØ Getters de conveniencia
    userId: authState.user?.uid || null,
    userEmail: authState.user?.email || null,
    userName: authState.user?.displayName || authState.user?.email || null,
    userPhoto: authState.user?.photoURL || null,

    // üéØ Funciones de estado
    isAuthenticated: authState.isLoggedIn && !authState.loading,
    isLoading: authState.loading
  };

  // üîÑ Mostrar loading mientras se determina el estado de auth
  if (authState.loading) {
    return (
      <div className="min-h-screen flex items-center justify-center">
        <div className="text-center">
          <div className="animate-spin text-4xl mb-4">‚è≥</div>
          <div className="text-gray-600">Verificando sesi√≥n...</div>
        </div>
      </div>
    );
  }

  return (
    <AuthContext.Provider value={contextValue}>
      {children}
    </AuthContext.Provider>
  );
};

export default AuthContext;
```

#### Paso 7: Integrar AuthProvider en la aplicaci√≥n
> **Archivo:** `src/main.jsx`
> **Acci√≥n:** Envolver la app con el proveedor de autenticaci√≥n

```jsx
import React from 'react';
import ReactDOM from 'react-dom/client';
import App from './App.jsx';
import './index.css';
import { AuthProvider } from './contexts/AuthContext.jsx'; // üëà NUEVO

ReactDOM.createRoot(document.getElementById('root')).render(
  <React.StrictMode>
    <AuthProvider> {/* üëà NUEVO: Envolver con AuthProvider */}
      <App />
    </AuthProvider>
  </React.StrictMode>
);
```

---

### ‚úÖ Resultado de la sesi√≥n

Al completar esta sesi√≥n tendr√°s:

**üîê Firebase Auth configurado**
- ‚úÖ Authentication habilitado en Firebase Console
- ‚úÖ M√©todos de login (Email/Password + Google) configurados
- ‚úÖ Dominios autorizados establecidos

**‚öôÔ∏è C√≥digo base preparado**
- ‚úÖ Servicios de autenticaci√≥n creados (`authService.js`)
- ‚úÖ Contexto global de auth (`AuthContext.jsx`)
- ‚úÖ Integraci√≥n con la aplicaci√≥n principal

**üéØ Funcionalidades disponibles**
- ‚úÖ Registro de usuarios con email/password
- ‚úÖ Login con email/password
- ‚úÖ Login con Google OAuth
- ‚úÖ Logout de sesiones
- ‚úÖ Observaci√≥n autom√°tica de cambios de estado
- ‚úÖ Manejo de errores user-friendly

### üß™ Pruebas cr√≠ticas

1. **Firebase Console** ‚Üí Authentication habilitado
2. **Console del navegador** ‚Üí Sin errores de Firebase Auth
3. **AuthContext loading** ‚Üí Pantalla de carga funciona
4. **Servicios importados** ‚Üí Sin errores de importaci√≥n

### üì∏ Capturas de verificaci√≥n
1. **Firebase Console** ‚Üí Authentication > Sign-in method ‚Üí Email y Google habilitados
2. **Navegador console** ‚Üí "üî• Firebase inicializado" con authConnected: true
3. **App funcionando** ‚Üí Sin errores, pantalla de loading inicial
4. **Network tab** ‚Üí Conexiones a Firebase Auth funcionando

### üöß Pr√≥ximos pasos
En las siguientes sesiones implementaremos:
- **Sesi√≥n 74:** Componentes de Login y Registro
- **Sesi√≥n 75:** Integraci√≥n con Google OAuth
- **Sesi√≥n 76:** Protecci√≥n de rutas y p√°ginas
- **Sesi√≥n 77:** Conectar tareas con usuarios autenticados
- **Sesi√≥n 78:** Finalizaci√≥n y deployment

### üîÑ Pr√≥xima sesi√≥n
**Sesi√≥n 74:** Componentes de Login y Registro - Crear interfaces de usuario para autenticaci√≥n

---

**üéØ Conceptos clave aprendidos:**
- Configuraci√≥n de Firebase Authentication
- Estructura de servicios de autenticaci√≥n
- Context API para estado global de auth
- Observer pattern para cambios de estado
- Manejo de m√∫ltiples proveedores de login
- Loading states en autenticaci√≥n
- Mapeo de errores user-friendly
